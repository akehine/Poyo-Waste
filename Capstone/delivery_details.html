<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=MuseoModerno:ital,wght@0,100..900;1,100..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
      rel="stylesheet"
    />
    <title>Poyo Waste</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Poppins", sans-serif;
      }

      body {
        font-family: "Poppins", sans-serif;
        background-color: #f9f9f9;
        margin: 0;
        padding: 0;
        min-height: 100vh;
      }

      .container {
        width: 100%;
        max-width: 480px;
        padding: 40px 20px;
        box-sizing: border-box;
        margin: 0 auto;
      }

      .header {
        display: flex;
        align-items: center;
        margin-bottom: 30px;
      }

      .back-button {
        width: 40px;
        height: 40px;
        background-color: #eee;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 15px;
        cursor: pointer;
      }

      .back-button svg {
        width: 20px;
        height: 20px;
        fill: #666;
      }

      h1 {
        font-size: 24px;
        text-align: center;
        margin: 0 auto;
        color: #333;
      }

      .card {
        background-color: white;
        border-radius: 15px;
        padding: 24px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 15px;
        display: block;
        color: #333;
      }

      .radio-group {
        margin-bottom: 10px;
      }

      .radio-option {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }

      .radio-option input[type="radio"] {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid #ccc;
        border-radius: 50%;
        margin-right: 10px;
        position: relative;
        cursor: pointer;
      }

      .radio-option input[type="radio"]:checked {
        border-color: #333;
      }

      .radio-option input[type="radio"]:checked:after {
        content: "";
        width: 10px;
        height: 10px;
        background-color: #333;
        border-radius: 50%;
        position: absolute;
        top: 3px;
        left: 3px;
      }

      .radio-option label {
        font-size: 16px;
        color: #666;
      }

      select {
        width: 100%;
        padding: 15px;
        background-color: #f0f0f0;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        color: #666;
        cursor: pointer;
        margin-bottom: 20px;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 15px;
      }

      .checkbox-container {
        display: flex;
        align-items: flex-start;
        margin: 30px 0;
      }

      .checkbox-container input[type="checkbox"] {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border: 1px solid #999;
        margin-right: 10px;
        position: relative;
        cursor: pointer;
        flex-shrink: 0;
      }

      .checkbox-container input[type="checkbox"]:checked:after {
        content: "âœ“";
        position: absolute;
        top: -1px;
        left: 4px;
        color: #333;
        font-size: 16px;
      }

      .checkbox-container label {
        font-size: 14px;
        color: #333;
        line-height: 1.4;
      }

      .continue-button {
        width: 100%;
        padding: 16px;
        background-color: #4e703a;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 18px;
        cursor: pointer;
        margin-top: 10px;
        transition: background-color 0.3s;
      }

      .continue-button:disabled {
        background-color: #a5b89c;
        cursor: not-allowed;
      }

      .error-message {
        color: #e53935;
        font-size: 14px;
        margin-top: 5px;
        display: none;
      }

      .success-message {
        background-color: #81c784;
        color: #1b5e20;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="back-button" id="back-btn">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
          </svg>
        </div>
        <h1>Pickup/Delivery Preferences</h1>
      </div>

      <div class="success-message" id="success-message">
        Your delivery has been scheduled successfully!
      </div>

      <form id="delivery-form">
        <div class="card">
          <div class="form-group">
            <div class="form-label">Service Type</div>
            <div class="radio-group">
              <div class="radio-option">
                <input
                  type="radio"
                  id="pickup"
                  name="service-type"
                  value="Pickup"
                  checked
                />
                <label for="pickup">I need a pickup service</label>
              </div>
              <div class="radio-option">
                <input
                  type="radio"
                  id="dropoff"
                  name="service-type"
                  value="Drop-off"
                />
                <label for="dropoff">I will drop off at your facility</label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group" id="location-container">
          <label for="location-select" class="form-label"
            >Preferred Location</label
          >
          <select id="location-select" class="location-select" required>
            <option value="" disabled selected>Select a location</option>
            <option value="Amazon Fulfillment Center A">
              Amazon Fulfillment Center A
            </option>
            <option value="Amazon Fulfillment Center B">
              Amazon Fulfillment Center B
            </option>
            <option value="Amazon Fulfillment Center C">
              Amazon Fulfillment Center C
            </option>
          </select>
          <div class="error-message" id="location-error">
            Please select a preferred location
          </div>
        </div>

        <div class="form-group">
          <label for="date-select" class="form-label">Preferred Date</label>
          <select id="date-select" class="date-select" required>
            <option value="" disabled selected>Select a date</option>
          </select>
          <div class="error-message" id="date-error">
            Please select a preferred date
          </div>
        </div>

        <div class="form-group">
          <label for="time-select" class="form-label">Preferred Time</label>
          <select id="time-select" class="time-select" required>
            <option value="" disabled selected>Select a time</option>
            <option value="9:00 AM">9:00 AM</option>
            <option value="10:00 AM">10:00 AM</option>
            <option value="11:00 AM">11:00 AM</option>
            <option value="12:00 PM">12:00 PM</option>
            <option value="1:00 PM">1:00 PM</option>
            <option value="2:00 PM">2:00 PM</option>
            <option value="3:00 PM">3:00 PM</option>
            <option value="4:00 PM">4:00 PM</option>
          </select>
          <div class="error-message" id="time-error">
            Please select a preferred time
          </div>
        </div>

        <div class="checkbox-container">
          <input type="checkbox" id="confirm" required />
          <label for="confirm"
            >I confirm that the information provided is accurate and that I am
            the rightful owner of the e-waste being submitted.</label
          >
          <div class="error-message" id="confirm-error">
            You must confirm this statement to continue
          </div>
        </div>

        <button type="submit" class="continue-button" id="continue-btn">
          Continue
        </button>
      </form>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        addDoc,
        updateDoc,
        doc,
        serverTimestamp,
        deleteDoc,
        getDoc,
        increment,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDgoc4Zx064nL1iydJbccI692HDpu8gLLE",
        authDomain: "capstone-project-312dc.firebaseapp.com",
        projectId: "capstone-project-312dc",
        storageBucket: "capstone-project-312dc.firebasestorage.app",
        messagingSenderId: "82712440613",
        appId: "1:82712440613:web:124a86e48a3b9c3e6bf4cc",
        measurementId: "G-YFF9RVYJ9C",
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Current user's inventory items
      let userInventoryItems = [];
      let currentUser = null;
      // Points per recycled item
      const POINTS_PER_ITEM = 5;

      document.addEventListener("DOMContentLoaded", function () {
        // Set up date options (next 14 days)
        populateDateOptions();

        // Set up event listeners
        const backButton = document.getElementById("back-btn");
        const deliveryForm = document.getElementById("delivery-form");

        if (backButton) {
          backButton.addEventListener("click", function () {
            window.location.href = "bucket.html";
          });
        }

        if (deliveryForm) {
          deliveryForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            if (validateForm()) {
              await submitDeliveryRequest();
            }
          });
        }

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            loadUserInventory(user.uid);
          } else {
            window.location.href = "login.html";
          }
        });
      });

      function populateDateOptions() {
        const dateSelect = document.getElementById("date-select");
        const today = new Date();

        for (let i = 1; i <= 14; i++) {
          const date = new Date();
          date.setDate(today.getDate() + i);

          if (date.getDay() === 0 || date.getDay() === 6) {
            continue;
          }

          const option = document.createElement("option");
          option.value = date.toISOString().split("T")[0];

          const options = {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
          };
          option.textContent = date.toLocaleDateString("en-US", options);

          dateSelect.appendChild(option);
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        // Set up date options (next 14 days)
        populateDateOptions();

        // Set up event listeners
        const backButton = document.getElementById("back-btn");
        const deliveryForm = document.getElementById("delivery-form");

        if (backButton) {
          backButton.addEventListener("click", function () {
            window.location.href = "bucket.html";
          });
        }

        if (deliveryForm) {
          deliveryForm.addEventListener("submit", async function (e) {
            e.preventDefault();
            if (validateForm()) {
              await submitDeliveryRequest();
            }
          });
        }

        // Set up service type radio button event listeners
        const pickupRadio = document.getElementById("pickup");
        const dropoffRadio = document.getElementById("dropoff");
        const locationContainer = document.getElementById("location-container");
        const locationSelect = document.getElementById("location-select");

        if (pickupRadio && dropoffRadio && locationContainer) {
          // Initial state setup
          handleServiceTypeChange();

          // Add event listeners for radio buttons
          pickupRadio.addEventListener("change", handleServiceTypeChange);
          dropoffRadio.addEventListener("change", handleServiceTypeChange);
        }

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUser = user;
            loadUserInventory(user.uid);
          } else {
            window.location.href = "login.html";
          }
        });

        function handleServiceTypeChange() {
          const isPickup = document.getElementById("pickup").checked;
          const locationContainer =
            document.getElementById("location-container");
          const locationSelect = document.getElementById("location-select");

          if (isPickup) {
            locationContainer.style.display = "block";
            locationSelect.required = true;
          } else {
            locationContainer.style.display = "none";
            locationSelect.required = false;
            locationSelect.value = "";
          }
        }
      });

      function validateForm() {
        let isValid = true;

        // Check service type
        const isPickup = document.getElementById("pickup").checked;

        // Validate location selection only if pickup is selected
        if (isPickup) {
          const locationSelect = document.getElementById("location-select");
          const locationError = document.getElementById("location-error");
          if (!locationSelect.value) {
            locationError.style.display = "block";
            isValid = false;
          } else {
            locationError.style.display = "none";
          }
        }

        // Validate date selection
        const dateSelect = document.getElementById("date-select");
        const dateError = document.getElementById("date-error");
        if (!dateSelect.value) {
          dateError.style.display = "block";
          isValid = false;
        } else {
          dateError.style.display = "none";
        }

        // Validate time selection
        const timeSelect = document.getElementById("time-select");
        const timeError = document.getElementById("time-error");
        if (!timeSelect.value) {
          timeError.style.display = "block";
          isValid = false;
        } else {
          timeError.style.display = "none";
        }

        // Validate confirmation checkbox
        const confirmCheckbox = document.getElementById("confirm");
        const confirmError = document.getElementById("confirm-error");
        if (!confirmCheckbox.checked) {
          confirmError.style.display = "block";
          isValid = false;
        } else {
          confirmError.style.display = "none";
        }

        return isValid;
      }

      async function loadUserInventory(userId) {
        try {
          const inventoryQuery = query(
            collection(db, "inventory"),
            where("uid", "==", userId),
            where("status", "==", "Pending")
          );

          const querySnapshot = await getDocs(inventoryQuery);
          userInventoryItems = [];

          querySnapshot.forEach((doc) => {
            const itemData = doc.data();
            // Calculate points to be earned (5 points per item)
            const pointsEarned = (itemData.amount || 1) * POINTS_PER_ITEM;

            userInventoryItems.push({
              id: doc.id,
              ...itemData,
              pointsEarned: pointsEarned,
            });
          });

          // Disable form if no pending items
          if (userInventoryItems.length === 0) {
            document.getElementById("continue-btn").disabled = true;
            alert(
              "No pending items found. Please add items to your bucket first."
            );
            setTimeout(() => {
              window.location.href = "bucket.html";
            }, 1000);
          }
        } catch (error) {
          console.error("Error loading inventory: ", error);
          alert("Error loading your items. Please try again later.");
        }
      }

      async function getNextDeliveryId() {
        try {
          const deliveriesRef = collection(db, "deliveries");
          const querySnapshot = await getDocs(deliveriesRef);

          let highestNum = 0;

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.customId && data.customId.startsWith("D")) {
              const numStr = data.customId.substring(1);
              const num = parseInt(numStr);
              if (!isNaN(num) && num > highestNum) {
                highestNum = num;
              }
            }
          });

          const nextNum = highestNum + 1;
          return `D${nextNum.toString().padStart(2, "0")}`;
        } catch (error) {
          console.error("Error getting next delivery ID:", error);
          const timestamp = new Date().getTime();
          return `D${timestamp}`;
        }
      }

      async function getNextDeliveryItemId() {
        try {
          const deliveryItemsRef = collection(db, "delivery_items");
          const querySnapshot = await getDocs(deliveryItemsRef);

          let highestNum = 0;

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.customId && data.customId.startsWith("IT")) {
              const numStr = data.customId.substring(2);
              const num = parseInt(numStr);
              if (!isNaN(num) && num > highestNum) {
                highestNum = num;
              }
            }
          });

          const nextNum = highestNum + 1;
          return `IT${nextNum.toString().padStart(2, "0")}`;
        } catch (error) {
          console.error("Error getting next delivery item ID:", error);
          const timestamp = new Date().getTime();
          return `IT${timestamp}`;
        }
      }
      async function submitDeliveryRequest() {
        try {
          const continueButton = document.getElementById("continue-btn");
          continueButton.disabled = true;
          continueButton.textContent = "Processing...";

          const serviceType = document.querySelector(
            'input[name="service-type"]:checked'
          ).value;
          const isPickup = serviceType === "Pickup";

          let preferredLocation = "Drop-off at Facility";
          if (isPickup) {
            preferredLocation =
              document.getElementById("location-select").value;
          }

          const preferredDate = document.getElementById("date-select").value;
          const preferredTime = document.getElementById("time-select").value;

          console.log("Items to process:", userInventoryItems.length);
          console.log("Items detail:", userInventoryItems);

          const customId = await getNextDeliveryId();

          if (!customId) {
            throw new Error("Failed to generate a delivery ID");
          }

          const deliveryData = {
            uid: currentUser.uid,
            customId: customId,
            location: preferredLocation,
            pickupType: serviceType,
            preferredDate: preferredDate,
            preferredTime: preferredTime,
            status: "Waiting for Pickup",
            createdAt: serverTimestamp(),
          };

          const deliveryDocRef = doc(db, "deliveries", customId);
          await setDoc(deliveryDocRef, deliveryData);
          console.log("Delivery created with ID:", customId);

          let totalPointsToAdd = 0;
          let processedItems = 0;

          for (const item of userInventoryItems) {
            try {
              const itemPoints = item.pointsEarned || 0;
              totalPointsToAdd += itemPoints;

              const itemCustomId = await getNextDeliveryItemId();

              if (!itemCustomId) {
                console.error("Failed to generate ID for item:", item.id);
                continue;
              }

              const deliveryItemData = {
                customId: itemCustomId,
                deliveryId: customId,
                inventoryId: item.id,
              };

              const deliveryItemDocRef = doc(
                db,
                "delivery_items",
                itemCustomId
              );
              await setDoc(deliveryItemDocRef, deliveryItemData);

              const itemDocRef = doc(db, "inventory", item.id);
              await updateDoc(itemDocRef, {
                status: "Scheduled",
                pointsEarned: itemPoints,
              });

              processedItems++;
              console.log(
                `Processed item ${processedItems}/${userInventoryItems.length}: ${item.id}`
              );
            } catch (itemError) {
              console.error("Error processing item:", item.id, itemError);
            }
          }

          console.log(
            `Successfully processed ${processedItems}/${userInventoryItems.length} items`
          );

          if (totalPointsToAdd > 0) {
            const userDocRef = doc(db, "users", currentUser.uid);
            const userDoc = await getDoc(userDocRef);
            const userData = userDoc.data();

            if (userData) {
              await updateDoc(userDocRef, {
                points: increment(totalPointsToAdd),
                pointsPLANT:increment(totalPointsToAdd),
              });
              console.log(`Added ${totalPointsToAdd} points to user`);
            }
          }

          document.getElementById(
            "success-message"
          ).innerHTML = `Your delivery has been scheduled successfully!<br>You've earned ${totalPointsToAdd} tomatoes!`;
          document.getElementById("success-message").style.display = "block";
          continueButton.textContent = "Complete";

          setTimeout(() => {
            window.location.href = "main_page.html";
          }, 2000);
        } catch (error) {
          console.error("Error submitting delivery request: ", error);
          alert("Error scheduling your delivery. Please try again.");

          const continueButton = document.getElementById("continue-btn");
          continueButton.disabled = false;
          continueButton.textContent = "Continue";
        }
      }
    </script>
  </body>
</html>
